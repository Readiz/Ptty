/**
 * @file   : ptty.jquery.js
 * @ver    : 0.0.4
 * @Author : Patxi Pierce
 * @url    : http://code.patxipierce.com/jquery-plugin/ptty/
 * @desc   : Ptty (Pachanka's teletype). A terminal emulator plugin for jQuery. 
 * @note   : Based on wterm.js by Venkatakrishnan Ganesh.
 * @license: Copyright 2014 Patxi Pierce <mail@patxipierce.com>
 *           This work is free. You can redistribute it and/or modify it under the
 *           terms of the Do What The Fuck You Want To Public License, Version 2,
 *           as published by Sam Hocevar. See the COPYING file for more details.
 * */
!function(t){var e="0.0.4",n=function(){return{url:window.location.pathname,method:"POST",param:"cmd",tty_class:"cmd_terminal",ps:"",theme:"boring",width:"100%",height:"100%",welcome:"Ptty v."+e,placeholder:"*",not_found:"<div> CMD: Command Not Found </div>",error_prefix:"An Error Occured: ",autocomplete:!0,history:!0,history_max:800,charset:"UTF-8",enctype:"multipart/form-data",autofocus:!0}},a={},s={},l={},o=[],c={cmd_name:null,cmd_class:null,cmd_ps:null,cmd_in:null,cmd_out:null,cmd_quiet:null,cmd_token:null,cmd_query:null,cmd_clean:null},u=n(),r=function(){t.register_command("clear","Cleans the screen leaving a new command prompt ready.","clear [no options]",function(){return t("."+u.tty_class+"_content").html(""),{type:"print",out:"",quiet:"clear"}}),u.history&&t.register_command("history","Shows list of typed in commands.","history [clear]",function(e){var n="";if("clear"==t.trim(e[1]))o=[];else if(o.length>0){var a,s;for(a in o)s=o[a],n+="<li>"+s+"</li>";n='<ul class="ve-li">'+n+"</ul>"}return{type:"print",out:n}}),t.register_command("help","Displays a list of useful information.","help [ [-a | --all] | [command] ]",function(e){var n="";if("string"==typeof e[1]&&e[1].length>0){var s=t.trim(e[1]);if("-a"==s||"--all"==s){n='<b>Available commands:</b></br></br><ul class="ve-li">';for(i in a)n+="<li><p><b>"+i+"</b> - "+a[i].desc+"</br>",n+="Usage: "+a[i].usage+"</p></br></li>";n+="</ul>\n"}else"undefined"!=typeof a[s]?(n="<b>"+s+"</b> - "+a[s].desc+"</br>",n+="Usage: "+a[s].usage+"\n"):n='help:</br>The "'+s+'" option does not exist.\n'}else{n='Use "help [comand name]" to display specific info about a command.</br>\n',n+='Available commands are:</br><ul class="sq-li">';for(i in a)n+="<li>"+i+"</li>";n+="</ul>\n"}return{type:"print",out:n}})};t.fn.Ptty=function(e){return u=t.extend(!0,u,e),this.each(function(){var n=t(this),p=null;n.addClass(u.tty_class).addClass(u.tty_class+"_theme_"+u.theme),u.width&&u.height&&n.css({width:u.width,height:u.height}),n.html("").append('<div class="'+u.tty_class+'_loading"><span></span></div><div class="'+u.tty_class+'_content"><div>'+u.welcome+'</div></div><div class="'+u.tty_class+'_prompt"><span class="'+u.tty_class+'_ps"><span class="'+u.tty_class+'_active">'+u.ps+'</span>&nbsp;</span><form accept-charset="'+u.charset+'" enctype="'+u.enctype+'"><input type="text" autocomplete="off" /><input type="password" /><span class="upl_container hide"><input type="file" /><a href="javascript:void(0)" onclick="$(this).parent().addClass(\'hide\').siblings(\'input[type=text]\').show();">Cancel</a></span></form><progress class="'+u.tty_class+'_progress"></progress></div>');var d=n.find("span."+u.tty_class+"_active"),f=n.find("div:last form"),_=f.find("input[type=text]"),m=f.find("input[type=password]"),h=f.find("input[type=file]"),y=n.find("div."+u.tty_class+"_content"),v=n.find("div."+u.tty_class+"_loading"),b=n.find("progress."+u.tty_class+"_progress"),g=null,w={ac_save:null,h_save:null};u.autofocus&&_.focus(),n.bind("select focus click",function(){_.is(":visible")?_.focus():m.is(":visible")&&m.focus()}),d.removeAttr("disabled"),r(e);var q=function(e,n,a){var s=c.cmd_class;null===s&&(s=g?u.tty_class+"_sub":u.tty_class+"_ps"),null!==c.cmd_in&&(n=c.cmd_in),null!==c.cmd_out&&(a=c.cmd_out),"clear"==c.cmd_quiet?(y.html(""),e=""):"password"==c.cmd_quiet?(n=Array(n.length+1).join(u.placeholder),e='<span class="'+s+'"><span>'+e+"</span>&nbsp;"+n+"</span>"):e="blank"==c.cmd_quiet?'<span class="'+s+'"><span>'+e+"</span>&nbsp;</span>":"output"==c.cmd_quiet?"":'<span class="'+s+'"><span>'+e+"</span>&nbsp;"+n+"</span>",y.append("<div>"+e+"<div>"+a+"</div></div>"),f.find("input").each(function(){t(this).val("")});for(opt in c)"cmd_clean"!==opt&&"cmd_name"!==opt&&"cmd_ps"!==opt&&"cmd_query"!==opt&&"cmd_token"!==opt&&(c[opt]=null);v.fadeOut(300),d.removeAttr("disabled").show()},k=function(){var t=g?g.ps:u.ps;return null!==c.cmd_ps?c.cmd_ps:t},x=function(t){return null===c.cmd_class&&(c.cmd_class=g?u.tty_class+"_sub":u.tty_class+"_ps"),null===t&&(t=g?g.ps:u.ps),d.html(t),t},C=function(e,n,s){var l={cmd:n};null!==c.cmd_query&&(l.cmd_query=c.cmd_query),null!==c.cmd_in&&(l.cmd=c.cmd_in),null!==c.cmd_token&&(l.cmd_token=c.cmd_token),n!==c.cmd_in&&(l.cbf=n),(s===!1||""==s||"undefined"==typeof s)&&(s=a[e].type_of?a[e].type_of:u.url),t.ajax({type:u.method,url:s,data:l}).done(function(t){t.ajax_url=s,t=t||"",S(n,t)}).fail(function(){q(k(),n,"<div>"+u.error_prefix+" Invalid server response. </div>")})},j=function(t,e,n){""==t?q(k(),e,""):null!==g?O(t,e,n):"undefined"==typeof a[t]?q(k(),e,u.not_found.replace("CMD",n[0])):"object"==typeof a[t].type_of?O(t,e,n):"string"==typeof a[t].type_of?C(t,e,!1):"function"==typeof a[t].type_of?P(a[t].type_of,n,e):C(t,e,u.url)},D=function(t){g=a[t].type_of,d.html(g.ps),n.find("div:last span:first").toggleClass(u.tty_class+"_ps "+u.tty_class+"_sub"),c.cmd_name=t,c.cmd_ps=u.ps,c.cmd_class=u.tty_class+"_ps",w.ac_save=u.autocomplete,u.autocomplete=!1,w.h_save=o,o=[]},A=function(){d.html(null),n.find("div:last span:first").toggleClass(u.tty_class+"_ps "+u.tty_class+"_sub"),c.cmd_ps=null!==c.cmd_ps?c.cmd_ps:g.ps,c.cmd_class=u.tty_class+"_ps",c.cmd_name=null,c.cmd_token=null,c.cmd_query=null,u.autocomplete=w.ac_save?w.ac_save:!1,o=w.h_save?w.h_save:[],g=null},O=function(t,e,n){var a=u.url;null==g?(D(t),a=g.start_hook):g&&("quit"==t||"exit"==t?(a=g.exit_hook,A()):a=g.dispatch_method),"string"==typeof a?C(t,e,a):"function"==typeof a&&P(a,n,e)},P=function(t,e,n){return S(n,t(e))},S=function(t,e){e=e||"";var n={ps:k(),output:""};switch(e.type){case"prompt":if(!c.cmd_token){var a=Math.random().toString(36).substr(2),s=Math.random().toString(36).substr(2),l=Math.random().toString(36).substr(2);c.cmd_token=a+s+l}break;case"password":_.hide(),m.show().focus();break;case"upload":"undefined"!=typeof e.upload_multiple&&h.attr("multiple","multiple"),"undefined"!=typeof e.upload_accept&&h.attr("accept",e.upload_accept),_.hide(),h.parent().removeClass("hide"),h.bind("change",function(){h.parent().addClass("hide"),_.show(),""!=h.val()&&E(this.files,e),h.attr("accept",""),h.attr("multiple",""),h.val("")});break;default:e.type="print"}("exit"==t||"quit"==t)&&(n.ps=c.cmd_ps,c.cmd_ps=null),c.cmd_ps="undefined"!=typeof e.ps?x(e.ps):null,"undefined"!=typeof e.class&&(c.cmd_class=e.class),"undefined"!=typeof e.in&&(c.cmd_in=e.in),"undefined"!=typeof e.out&&(n.output=c.cmd_out=e.out),"undefined"!=typeof e.quiet&&(c.cmd_quiet=e.quiet),"undefined"!=typeof e.token&&(c.cmd_token=e.token),"undefined"!=typeof e.query&&(c.cmd_query=e.query),"undefined"!=typeof e.clean&&(c.cmd_clean=e.clean),q(n.ps,t,n.output),"undefined"!=typeof e.exit&&g&&(A(),c.cmd_ps=null),"undefined"!=typeof e.callback&&"upload"!==e.type&&T(n,e)},T=function(t,e){try{if("function"!=typeof s[e.callback])throw u.error_prefix+" "+e.callback+" callback unknown.";t.output=s[e.callback](e)}catch(n){}},M=function(){var t=0,e=new_height=n.height(),a=setInterval(function(){e!=new_height?(clearInterval(a),n.animate({scrollTop:new_height},"slow")):t>=30?(clearInterval(a),n.animate({scrollTop:new_height},"slow")):(new_height=y.height(),t++)},50)},I=function(t){t.lengthComputable&&b.attr({value:t.loaded,max:t.total})},U=function(){_.is(":visible")?(_.val(""),_.focus()):m.is(":visible")&&(m.val(""),m.focus()),M()},E=function(e,n){var a="";if("undefined"!=typeof n.upload_to)var s=n.upload_to;else var s=null!==g?g.dispatch_method:u.url;for(var l=new FormData,i=0;i<e.length;i++)l.append("file_"+i,e[i]),a+=" "+e[i].name;for(var o in n)l.append(o,n[o]);b.show(),t.ajax({url:s,type:"POST",xhr:function(){var e=t.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",I,!1),e},data:l,cache:!1,contentType:!1,processData:!1}).done(function(t){q(k(),a,t.out)}).fail(function(){"undefined"!=typeof response.out?response.out:"Error.";q(k(),a,response.out)}).always(function(){b.hide()})};f.submit(function(e){e.preventDefault(),e.stopPropagation();var n,s;if(m.val().length)n=m.val(),m.val("");else if(h.val().length)n=h.val(),h.val("");else{n=t.trim(t("<div/>").text(_.val()).html());var s=" "==n.charAt(0)?!1:!0}if(c.cmd_in=n,null!==c.cmd_query&&(n=c.cmd_query+n),null!==c.cmd_clean){if("object"==typeof c.cmd_clean)for(var i=0;i<c.cmd_clean.length;i++){var r="cmd_"+c.cmd_clean[i];c.hasOwnProperty(r)&&(c[r]=null)}else"string"==typeof c.cmd_clean&&c.hasOwnProperty("cmd_"+c.cmd_clean)&&(c["cmd_"+c.cmd_clean]=null);x(c.cmd_ps),c.cmd_clean=null}var f=n.split(/\s+/),y=f[0];if(u.history&&("undefined"!=typeof a[y]||g)&&s&&n.length&&null===c.cmd_quiet&&(o.length>u.history_entries&&o.shift(),o.push(t.trim(t("<div/>").html(n).text()))),p=0,v.show(),d.attr("disabled","disabled").hide(),y in l&&"function"==typeof l[y]){var b=l[y](n);if(b===!1)return U(),q(k(),n,"");"string"==typeof b&&(n=b,f=n.split(/\s+/),y=f[0])}j(y,n,f),U()}),_.keydown(function(e){var n=e.keyCode;switch(n){case 9:if(e.preventDefault(),u.autocomplete){var s=[],l=t.trim(_.val());if(l.match(/^[^\s]{0,}$/)){for(i in a)""==l?s.push(i):0==i.indexOf(l)&&s.push(i);s.length>1?q(k(),l,'<ul class="sq-li"><li>'+s.join("</li><li>")+"</li></ul>"):1==s.length&&_.val(s.pop()+" ")}}M();break;case 38:e.preventDefault(),u.history&&(p=null===p||0==p?o.length-1:p-1,_.val(o[p]));break;case 40:if(e.preventDefault(),u.history){if(null===p||p==o.length-1){_.val("");break}p++,_.val(o[p])}break;case 13:e.preventDefault(),f.submit(),M(),_.focus()}}),m.keydown(function(t){if(m.is(":visible")){var e=t.keyCode;switch(e){case 13:t.preventDefault(),f.submit(),m.hide(),_.show(),M(),_.focus()}}}),t(document).keydown(function(t){var e=t.keyCode;switch(e){case 27:_.is(":visible")?_.focus():m.is(":visible")?m.focus():h.is(":visible")&&h.parent().addClass("hide").siblings("input[type=text]").show().focus()}})})},t.register_command=function(t,e,n,s){var l=!1;return("string"==typeof s||"object"==typeof s||"function"==typeof s)&&(a[t]={desc:e,usage:n,type_of:s},l=!0),l},t.register_callback=function(t,e){var n=!1;return("string"==typeof e||"object"==typeof e||"function"==typeof e)&&(s[t]=e,n=!0),n},t.register_callbefore=function(t,e){var n=!1;return"function"==typeof e&&(l[t]=e,n=!0),n},t.flush_commands=function(e){a={},t.set_command_option(e),r(e)},t.set_command_option=function(e){return t.extend(!0,c,e)},t.get_command_option=function(t){var e={};if("string"==typeof t)"undefined"!=typeof c[t]&&(e[t]=c[t]);else for(opt in t)"undefined"!=typeof c[opt]&&(e[opt]=c[opt]);return e},t.tokenize=function(e,n){var a={},s=value=quote_type=quote_open=!1,l=e.split(/\s+/);l.shift();for(var i=0;i<l.length;i++)t.inArray(l[i],n)>=0?(s=l[i],value=!1):'"'==l[i].charAt(0)&&quote_open===!1?(quote_type='"',quote_open=!0,value=l[i]):"'"==l[i].charAt(0)&&quote_open===!1?(quote_type="'",quote_open=!0,value=l[i]):l[i].slice(-1)==quote_type&&quote_open===!0?(quote_open=!1,value+=" "+l[i],value=t.trim(value.substring(1).slice(0,-1).replace(/\\(.)/gm,"$1"))):quote_open===!0?value+=" "+l[i]:value=l[i],s&&quote_open===!1&&(a[s]=value);return a}}(jQuery);